# Telegram 删除消息记录器模块化重构计划

## 当前问题

当前的 `tg_delete_logger.py` 文件存在以下问题：

1. 文件过大，包含了太多功能
2. 缺乏模块化结构，难以维护和扩展
3. 混合了多种职责（数据库操作、Telegram API 交互、媒体文件处理等）
4. 全局变量使用过多
5. 缺少适当的错误处理和日志记录策略

## 重构目标

1. 将代码拆分为多个功能明确的模块
2. 减少全局变量的使用，改用依赖注入
3. 提高代码的可测试性
4. 改进错误处理和日志记录
5. 使代码结构更清晰，便于未来扩展

## 模块化拆分计划

### 1. 项目结构

```
telegram_logger/
├── __init__.py
├── main.py                  # 主入口点
├── config.py                # 配置文件（从现有的 config.py 导入）
├── data/
│   ├── __init__.py
│   ├── models.py            # 数据库模型
│   └── database.py          # 数据库操作
├── handlers/
│   ├── __init__.py
│   ├── message_handler.py   # 消息处理
│   ├── delete_handler.py    # 删除消息处理
│   ├── edit_handler.py      # 编辑消息处理
│   └── forward_handler.py   # 转发消息处理
├── utils/
│   ├── __init__.py
│   ├── media.py             # 媒体文件处理
│   ├── mentions.py          # 创建提及链接
│   └── logging.py           # 日志工具
└── services/
    ├── __init__.py
    ├── client.py            # Telegram 客户端服务
    └── cleanup.py           # 清理过期消息服务
```

### 2. 模块职责划分

#### 2.1 主模块 (main.py)

- 初始化 Telegram 客户端
- 注册事件处理器
- 启动应用程序

#### 2.2 数据库模块 (data/)

- **models.py**: 定义消息数据模型
- **database.py**: 提供数据库连接和操作函数
  - 初始化数据库
  - 保存消息
  - 查询消息
  - 删除过期消息

#### 2.3 处理器模块 (handlers/)

- **message_handler.py**: 处理新消息
- **delete_handler.py**: 处理删除的消息
- **edit_handler.py**: 处理编辑的消息
- **forward_handler.py**: 处理需要转发的消息

#### 2.4 工具模块 (utils/)

- **media.py**: 媒体文件处理
  - 保存媒体文件
  - 检索媒体文件
  - 获取文件名
- **mentions.py**: 创建提及链接
- **logging.py**: 日志配置和工具

#### 2.5 服务模块 (services/)

- **client.py**: Telegram 客户端服务
  - 客户端初始化
  - 会话管理
- **cleanup.py**: 清理服务
  - 删除过期消息
  - 删除过期媒体文件

### 3. 重构步骤

✅ 1. **创建项目结构**
   - 创建所有必要的目录和空文件

2. **配置模块**
   - 从现有的 config.py 导入配置
   - 创建配置验证函数

[当前进度]
- 已完成步骤1
- 下一步应进行配置模块重构

3. **数据库模块**
   - 将数据库初始化和操作从主文件移至 data/database.py
   - 创建消息模型在 data/models.py 中

4. **工具模块**
   - 提取媒体处理函数到 media.py
   - 提取提及创建函数到 mentions.py
   - 设置日志配置在 logging.py

5. **处理器模块**
   - 将消息处理逻辑分离到各个处理器文件
   - 重构处理器以使用依赖注入而非全局变量

6. **服务模块**
   - 创建客户端服务
   - 实现清理服务

7. **主模块**
   - 创建应用程序入口点
   - 连接所有模块

### 4. 改进点

1. **依赖注入**
   - 使用类和对象替代全局变量
   - 通过构造函数传递依赖

2. **异步处理**
   - 保持异步函数的一致性
   - 使用 asyncio 进行并发操作

3. **错误处理**
   - 添加更详细的异常处理
   - 实现重试机制

4. **日志记录**
   - 为每个模块设置专门的日志记录器
   - 添加更详细的日志信息

5. **类型提示**
   - 为所有函数添加类型提示
   - 使用 mypy 进行类型检查

### 5. 测试策略

1. 为每个模块创建单元测试
2. 使用模拟对象测试 Telegram API 交互
3. 创建集成测试验证模块间交互

## 迁移注意事项

1. 保持现有功能的完整性
2. 确保数据库兼容性
3. 在迁移过程中保留详细日志
4. 考虑添加配置选项以启用/禁用特定功能
5. 为新结构创建详细文档
