# 项目开发规范

本文档旨在为参与 Telegram 消息日志系统 (telegram-delete-logger) 项目的开发人员（包括 AI 助手）提供一套清晰的开发指南和约定。

## 1. 项目目标

本项目旨在创建一个稳定、可配置的 Telegram 消息处理系统，其核心功能包括：

-   **消息记录**: 监听并持久化存储指定 Telegram 聊天的消息（包括新消息、编辑和删除事件）。
-   **媒体处理**: 安全地下载、加密存储和检索消息中的媒体文件。
-   **消息转发**: 根据配置规则，自动将来自特定用户或群组的消息转发到指定的日志频道。
-   **数据清理**: 定期自动删除过期的消息和媒体文件，以管理存储空间。
-   **配置灵活**: 通过 `.env` 文件提供丰富的配置选项，方便用户定制行为。
-   **安全性**: 对敏感信息（如媒体文件）进行加密存储。

## 2. 开发风格

为确保代码的一致性、可读性和可维护性，请遵循以下开发风格：

-   **语言**: 使用 Python 3.13+。
-   **异步编程**: 大量使用 `async`/`await` 语法，特别是与 `telethon` 库交互的部分。
-   **模块化**: 代码按功能组织在不同的包 (`data`, `handlers`, `services`, `utils`) 和模块中。保持高内聚、低耦合。
-   **面向对象**: 合理使用类（Classes）和数据类（Dataclasses）来封装数据和行为。
-   **类型提示**: 严格使用类型提示 (Type Hinting)，并使用 `mypy` 进行检查。
-   **日志**: 使用 Python 内置的 `logging` 模块进行日志记录。
-   **配置**: 使用 `.env` 文件和 `python-dotenv` 库管理配置。敏感信息（如 API 密钥）绝不能硬编码在代码中。
-   **错误处理**: 实现健壮的错误处理机制，特别是在处理网络请求和文件 IO 时。
-   **代码注释**: 遵循 `.rules/conventions.md` 的约定，所有代码注释必须使用中文。
-   **依赖管理**: 使用 `uv` 和 `pyproject.toml` 管理项目依赖，并通过 `uv.lock` 锁定版本。

## 3. 主要依赖

-   **核心库**:
    -   `telethon`: 用于与 Telegram API 交互。
    -   `cryptg`: 可能用于 Telethon 内部加密。
    -   `pyaescrypt`: 用于媒体文件的加密/解密。
    -   `python-dotenv`: 用于加载 `.env` 配置文件。
-   **测试框架**:
    -   `pytest`: 用于编写和运行单元测试及集成测试。

## 4. 开发工具

-   **包管理器**: `uv`
-   **代码检查**: `flake8` (包括 `flake8-import-order`)
-   **类型检查**: `mypy`
-   **测试运行器**: `pytest`
-   **版本控制**: Git
-   **容器化**: Docker (用于部署和提供一致的运行环境)

## 5. LLM 协作指南

与 AI 助手（如 Aider）协作时，请遵循以下指南以提高效率和准确性：

1.  **沟通语言**: 严格遵循 `.rules/conventions.md`，使用中文进行所有交互，专业术语和代码标识符除外。
2.  **代码修改**:
    -   **明确性**: 指示 AI 进行修改时，应提供清晰、无歧义的指令。
    -   **精确性**: 优先要求 AI 提供具体的代码片段更改（例如，使用 diff 格式或明确指出要添加/删除/修改的行），而不是整个文件或函数，除非重构需要。
    -   **上下文**: 确保 AI 拥有足够的上下文信息（例如，相关的代码文件、错误消息、需求描述）。
3.  **遵循规范**: 要求 AI 生成的代码严格遵守本文件中定义的**开发风格**（异步、类型提示、模块化、中文注释等）。
4.  **依赖变更**: 如果修改涉及到添加、删除或更新依赖，必须指示 AI 更新 `pyproject.toml` 文件，并提醒开发者需要重新生成 `uv.lock` 文件 (`uv pip compile pyproject.toml -o uv.lock`)。
5.  **测试**: 对于新增功能或修复的 Bug，应考虑要求 AI 辅助编写或更新相关的测试用例 (`pytest`)。
6.  **配置和文档**: 如果修改影响了配置选项或用户可见的行为，应指示 AI 更新 `.env.example` 文件和 `README.md` 文档。
7.  **审查**: AI 生成的代码必须经过人工审查，以确保其正确性、安全性和符合项目规范。
