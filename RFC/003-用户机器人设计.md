# RFC 003: 用户账户提及自动回复机器人设计

**状态:** 已接受
**创建日期:** 2025-04-23
**作者:** AI Assistant & User

## 1. 概述

本 RFC 旨在定义一个新功能：为用户的个人 Telegram 账户添加自动回复能力。当用户在群组中被其他成员提及 (@) 时，该账户可以自动发送预设的回复。用户应能通过与自己账户的私聊（或收藏夹）发送指令来控制此功能的开关和回复内容。

## 2. 动机

- 利用 AI 的能力，让用户的个人账户能够在指定的 Telegram 群组中，自动地、智能地参与讨论，与其他群组成员进行互动。
- 探索一种新颖的人机交互方式，让 AI 作为用户在社交平台上的代理或助手。
- 提供一个由用户控制的框架，允许用户配置和引导 AI 在特定群组中的行为。

## 3. 核心需求

### 3.1 自动提及回复 (Auto-Mention Reply)

- **触发条件:**
  - 在用户**预先设定或通过命令指定的目标群组**中。
  - **满足以下任一条件:**
    - 有**其他用户**通过 `@<你的用户名>` 的方式明确提及你。
    - 有**其他用户**对你**之前发送的消息**进行了**回复 (Reply)**，并且**回复触发已启用** (见下方控制指令)。
- **响应动作:**
  - 用户的个人账户**自动**在**同一个群组**中发送一条消息。
  - 该消息应作为对触发提及消息的**回复 (Reply)** 发送。
- **响应内容:**
  - 发送的文本内容应是**可配置**的，由用户预先设定。

### 3.2 功能控制 (Control Panel)

- **控制界面:** 用户通过向**自己的账户**发送消息（通常在“收藏夹”或与自己的私聊窗口）来下达指令。
- **指令格式:** 使用以英文句点 `.` 开头的文本命令（例如，`.on`, `.help`）。
- **可执行操作:**
  
  **核心功能控制:**
  - **启用:** `.on` - 开启自动提及回复功能。
  - **禁用:** `.off` - 关闭自动提及回复功能。
  - **查询状态:** `.status` - 查看当前功能启用状态、回复触发状态、当前选择的 AI 模型、角色（包括类型）、生效的目标群组列表以及频率限制。

  **回复触发控制:**
  - **启用回复触发:** `.replyon` - 允许在他人回复你的消息时触发自动回复。
  - **禁用回复触发:** `.replyoff` - 禁止在他人回复你的消息时触发自动回复 (仅 @ 提及有效)。

  **AI 模型管理:**
  - **选择 AI 模型:** `.setmodel <模型ID或别名>` - 选择当前用于生成回复的 AI 模型 (例如, `.setmodel gpt-4o` 或 `.setmodel 4o`)。
  - **列出可用模型:** `.listmodels` - 显示可供选择的 AI 模型及其别名。
  - **设置模型别名:** `.aliasmodel <模型ID> <别名>` - 为指定的模型 ID 设置一个易记的别名 (例如, `.aliasmodel gpt-4o 4o`)。
  - **删除模型别名:** `.unaliasmodel <别名>` - 删除一个已设置的模型别名 (例如, `.unaliasmodel 4o`)。

  **AI 角色管理:**
  - **选择 AI 角色:** `.setrole <别名或角色描述>` - 选择当前使用的角色。系统会根据该角色的类型（Static/AI）决定是直接回复还是调用 AI。推荐使用别名选择 (例如, `.setrole helper`)。
  - **列出可用角色:** `.listroles` - 显示所有已定义的角色别名、其类型（Static/AI）以及对应的描述内容。
  - **设置角色别名:** `.aliasrole <别名> "<角色描述>" [--type <static|ai>]` - 为一个角色描述设置别名，并指定其类型（默认为 `ai`）。`static` 类型表示直接发送描述文本作为回复；`ai` 类型表示将描述作为提示交给 AI 模型生成回复。
    - 示例 (AI, 默认): `.aliasrole helper "你是一个乐于助人的助手"`
    - 示例 (Static): `.aliasrole meeting "正在开会，稍后回复" --type static`
    - 示例 (AI, 显式): `.aliasrole translator "请将以下内容翻译成英文：" --type ai`
  - **删除角色别名:** `.unaliasrole <别名>` - 删除一个已设置的角色别名 (例如, `.unaliasrole helper`)。

  **目标群组管理:**
  - **添加目标群组:** `.addgroup <群组ID或群组链接>` - 将指定群组添加到自动回复生效的列表中。
  - **移除目标群组:** `.delgroup <群组ID或群组链接>` - 将指定群组从自动回复生效的列表中移除。
  - **列出目标群组:** `.listgroups` - 显示当前所有生效的目标群组列表。

  **频率限制:**
  - **设置频率限制:** `.setlimit <秒数>` - 设置在同一群组内触发自动回复的最小时间间隔（例如，`.setlimit 120` 表示同一群组内两次自动回复至少间隔 120 秒）。

  **帮助:**
  - **显示帮助:** `.help` - 显示所有可用的控制指令及其说明。
- **操作反馈:**
  - 系统在接收并处理完用户指令后，必须在同个聊天窗口（用户与自己的私聊）中发送一条**确认消息**，明确告知操作结果。示例：
    - `.on`: "自动回复已启用。"
    - `.replyon`: "回复触发已启用。"
    - `.addgroup`: "群组 '项目讨论' 已添加到目标列表。"
    - `.setlimit`: "频率限制已设置为 120 秒。"
    - `.setmodel`: "AI 模型已设置为 gpt-4o (别名: 4o)。"
    - `.aliasmodel`: "已为模型 gpt-4o 设置别名 4o。"
    - `.unaliasmodel`: "模型别名 4o 已删除。"
    - `.setrole`: "AI 角色已设置为 'helper' (类型: AI)。"
    - `.aliasrole ... --type static`: "已为角色 '正在开会...' 设置别名 meeting (类型: Static)。"
    - `.aliasrole ...`: "已为角色 '你是一个...' 设置别名 helper (类型: AI)。"
    - `.unaliasrole`: "角色别名 helper 已删除。"
    - `.status`: (回复状态信息，见下)
  - 对于 `.listmodels` 指令，系统应回复类似：
    ```
    可用模型：
    - gpt-4o (别名: 4o)
    - gpt-3.5-turbo (别名: 3.5)
    - claude-3-opus (别名: opus)
    ```
  - 对于 `.listroles` 指令，系统应回复类似：
    ```
    可用角色：
    - helper (AI): 你是一个乐于助人的助手
    - meeting (Static): 正在开会，稍后回复
    - translator (AI): 请将以下内容翻译成英文：
    ```
  - 对于 `.status` 指令，系统应回复类似：`当前状态：已启用，回复触发：已启用，模型：gpt-4o (别名: 4o)，角色：helper (AI) (内容: 你是一个乐于助人的助手)，目标群组：[群组 A, 群组 B]，频率限制：60 秒`
  - 对于 `.help` 指令，系统应回复包含所有指令列表的帮助信息。

## 4. 详细需求与考虑点

- **作用域:**
  - _MVP (P1 - 必须):_ 自动回复功能**仅**在用户通过命令明确指定的**目标群组列表**中生效。用户必须能够通过命令添加、删除和查看这个列表。
- **默认状态:**
  - 首次使用或未配置时，功能应处于**禁用**状态，目标群组列表为空。
  - **回复触发**功能默认应处于**禁用**状态。
  - 默认 AI 角色应为空或有预设值（例如，`default_assistant (AI): 我是 AI 助手，可以回答你的问题。`）。
  - 默认 AI 模型应有预设值 (例如, `gpt-3.5-turbo`)。
- **频率限制:**
  - _MVP (P1 - 必须):_ 应加入频率限制机制，避免在短时间内对同一群组的多次提及重复发送自动回复，防止刷屏。
  - **实现方式:** 使用一个内存中的字典（`dict`），以**目标群组 ID** 为键，存储该群组内**最后一次成功发送自动回复的时间戳**。每次触发时，检查当前时间与记录时间戳的差值是否大于设定的时间间隔。
  - **作用域:** 此限制是**针对每个目标群组独立计算**的，不是全局限制，也不是针对提及用户的限制。
  - **默认值:** 同一群组内，两次自动回复的最小时间间隔默认为 **60 秒**。
  - **可配置:** 用户可以通过 `.setlimit <秒数>` 指令修改此时间间隔。
- **输入验证:**
  - _MVP (P1 - 必须):_ 在执行 `.addgroup` 命令时，系统必须尝试验证用户提供的群组 ID 或链接是否有效，以及该实体是否确实是一个群组或频道。可以使用 `client.get_entity()` 等方法进行检查。如果验证失败，应向用户返回错误提示，并且不添加该无效条目。
- **安全性:** 控制指令必须严格验证发送者是否为用户本人，且通常应只在与用户自己的私聊中生效。
- **错误处理:** 如果自动回复发送失败（例如，权限不足、网络问题），应有内部日志记录，但不应打扰用户或在群组中发送错误提示。
- **触发优先级/合并:** 如果一条消息同时满足 @ 提及和回复触发条件（且回复触发已启用），自动回复**仅触发一次**。
- **核心开关与回复触发的关系:**
  - `.on`/`.off` 指令是整个自动回复功能的**主开关**。当设置为 `.off` 时，无论 `.replyon`/`.replyoff` 如何设置，都不会触发任何自动回复。
  - `.replyon`/`.replyoff` 指令是**子开关**，仅在主开关为 `.on` 时生效。它控制机器人是否对“他人回复你的消息”这一事件做出反应。
  - **分开设置的意义:** 这提供了更精细的控制。用户可以选择：
    - **仅响应明确提及 (`.on` + `.replyoff` - 默认):** 只在有人 `@<你的用户名>` 时回复，避免在普通讨论中过度干扰。
    - **响应提及和回复 (`.on` + `.replyon`):** 在有人 `@提及` 或回复你的消息时都进行回复，适用于希望机器人更积极参与相关讨论串的场景。
  - 默认情况下，回复触发是禁用的 (`.replyoff`)，以实现最小干扰。

## 5. 用户场景示例

1. **基本自动回复设置**
   - 用户希望在被提及时自动回复"正在开会，稍后回复"
   - `.aliasrole meeting "正在开会，稍后回复" --type static` (明确指定为静态类型)
   - `.setrole meeting`
   - `.addgroup <工作群组ID>`
   - `.on`

2. **智能AI助手模式**
   - 用户希望在技术讨论群组中使用GPT-4o模型进行智能回复
   - `.aliasmodel gpt-4o 4o`
   - `.setmodel 4o`
   - `.aliasrole tech_helper "你是一个技术助手，请用专业但友好的方式回答问题"`
   - `.setrole tech_helper`
   - `.addgroup <技术群组ID>`
   - `.replyon` (允许回复触发)
   - `.setlimit 120` (设置2分钟冷却时间)
   - `.on`

3. **多群组不同配置**
   - 工作群组: 简单自动回复
     - `.aliasrole work "工作时间内，请通过邮件联系"`
     - `.setrole work`
     - `.addgroup <工作群组ID>`
   - 兴趣群组: AI互动模式
     - `.setrole tech_helper`
     - `.addgroup <兴趣群组ID>`
   - 使用`.status`查看当前所有配置

4. **临时禁用与调整**
   - 临时关闭所有回复: `.off`
   - 调整单个群组: 
     - `.delgroup <群组ID>` (移除不需要的群组)
     - `.setlimit 180` (调整冷却时间)
   - 完全重置: 
     - `.off`
     - `.unaliasrole *` (删除所有角色别名)
     - `.unaliasmodel *` (删除所有模型别名)
